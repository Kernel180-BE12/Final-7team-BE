<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.softlabs.aicontents.domain.datacollector.mapper.ProductInfoMapper">

    <!-- 상품 정보 삽입 -->
    <insert id="insertProduct" parameterType="com.softlabs.aicontents.domain.datacollector.model.ProductInfo">
        INSERT INTO product (
            keyword,
            product_name,
            product_name_cn,
            price,
            description,
            rating,
            product_url,
            image_url,
            local_image_path,
            crawl_type,
            ocr_text,
            created_at
        ) VALUES (
            #{keyword},
            #{productName},
            #{productNameCn},
            #{price},
            #{description},
            #{rating},
            #{productUrl},
            NULL,
            NULL,
            #{crawlType},
            NULL,
            CURRENT_TIMESTAMP
        )
    </insert>

    <!-- 최근 상품 조회 -->
    <select id="selectRecentProducts" resultType="com.softlabs.aicontents.domain.datacollector.vo.response.ProductInfoVo">
        SELECT
            product_id,
            keyword,
            product_name,
            product_name_cn,
            price,
            description,
            rating,
            product_url,
            image_url,
            local_image_path,
            crawl_type,
            ocr_text,
            TO_CHAR(created_at, 'YYYY-MM-DD HH24:MI:SS') as created_at
        FROM product
        ORDER BY created_at DESC
        <if test="limit != null and limit > 0">
            FETCH FIRST #{limit} ROWS ONLY
        </if>
    </select>

    <!-- 조건별 상품 검색 -->
    <select id="selectProductsByCondition" parameterType="com.softlabs.aicontents.domain.datacollector.vo.request.ProductSearchVo"
            resultType="com.softlabs.aicontents.domain.datacollector.vo.response.ProductInfoVo">
        SELECT
            product_id,
            keyword,
            product_name,
            product_name_cn,
            price,
            description,
            rating,
            product_url,
            image_url,
            local_image_path,
            crawl_type,
            ocr_text,
            TO_CHAR(created_at, 'YYYY-MM-DD HH24:MI:SS') as created_at
        FROM product
        <where>
            <if test="keyword != null and keyword != ''">
                AND keyword LIKE '%' || #{keyword} || '%'
            </if>
            <if test="crawlType != null and crawlType != ''">
                AND crawl_type = #{crawlType}
            </if>
        </where>
        ORDER BY created_at DESC
        <if test="limit != null and limit > 0">
            OFFSET #{offset, jdbcType=INTEGER} ROWS
            FETCH FIRST #{limit} ROWS ONLY
        </if>
    </select>

    <!-- ID로 상품 조회 -->
    <select id="selectProductById" resultType="com.softlabs.aicontents.domain.datacollector.vo.response.ProductInfoVo">
        SELECT
            product_id,
            keyword,
            product_name,
            product_name_cn,
            price,
            description,
            rating,
            product_url,
            image_url,
            local_image_path,
            crawl_type,
            ocr_text,
            TO_CHAR(created_at, 'YYYY-MM-DD HH24:MI:SS') as created_at
        FROM product
        WHERE product_id = #{productId}
    </select>

    <!-- 키워드별 상품 수 조회 -->
    <select id="countProductsByKeyword" resultType="int">
        SELECT COUNT(*)
        FROM product
        WHERE keyword = #{keyword}
    </select>

    <!-- 마지막 삽입 ID 조회 -->
    <select id="selectLastInsertId" resultType="Long">
        SELECT product_seq.CURRVAL FROM DUAL
    </select>

</mapper>